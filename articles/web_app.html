<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="kwb.qmra">
<title>Web-app development with OpenCpu â€¢ kwb.qmra</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Web-app development with OpenCpu">
<meta property="og:description" content="kwb.qmra">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-default navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">kwb.qmra</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.3.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/general.html">Background</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-workflow">Workflow</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-workflow">
    <a class="dropdown-item" href="../articles/installation.html">1 Installation</a>
    <a class="dropdown-item" href="../articles/usage.html">2 Usage (Uniform Inflow)</a>
    <a class="dropdown-item" href="../articles/usage_log10_uniform_inflow.html">3 Usage (Log10 Uniform Inflow)</a>
    <a class="dropdown-item" href="../articles/usage_log10_norm_inflow.html">4 Usage (Log10 Norm Inflow)</a>
    <a class="dropdown-item" href="../articles/web_app.html">5 Web-app development</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tests">Tests</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tests">
    <a class="dropdown-item" href="../articles/test_random_distributions_inflow.html">1 Random Distributions For Inflow</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/kwb-r/kwb.qmra">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="web_app_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Web-app development with OpenCpu</h1>
                        <h4 data-toc-skip class="author">Michael Rustler</h4>
            
            <h4 data-toc-skip class="date">08 June, 2022</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/KWB-R/kwb.qmra/blob/HEAD/vignettes/web_app.Rmd" class="external-link"><code>vignettes/web_app.Rmd</code></a></small>
      <div class="d-none name"><code>web_app.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>For developing a web application, which is based on the R package <code>kwb.qmra</code> the <a href="https://www.opencpu.org/api.html" class="external-link">OpenCPU API</a> can be used. It has a lot of great features which its author Jeroen Ooms describes as follows (<a href="https://www.quora.com/How-do-plumber-and-OpenCPU-compare-when-it-comes-to-deploying-ML-models" class="external-link">Source</a>):</p>
<blockquote>
<p>"OpenCPU is mature has been put to the test in production for many years now, both in private and public organizations. The system was developed out of a need for a reliable, scalable system for embedding R that we used at UCLA for teaching R to students, sometimes several classes at once (think about a classroom settings with 100+ concurrent students). The core implementation of OpenCPU is the opencpu-server stack based on systems native Apache2 webserver. The opencpu-server stack has been packaged as deb/rpm packages and can be installed out of the box on all popular Linux systems. This really provides a super stable production ready system out-of-the-box. Not only does it easily scale up but you can configure the server (if you want to add auth, proxies, etc) via standard Apache configuration on your server. An incredible amount of time and energy has been invested into optimizing the internals of opencpu-server for security, reliability and performance. In opencpu-server, each incoming request gets processed in a temporary process fork which serves as a sandbox that controls memory/cpu limits, access control, timeouts, etc. All these are critical to ensure that the stability of the server does not get compromised by users or packages (accidentally) messing with the system or using excessive resources. I am not aware of any other R server system that does this.</p>
<p>More details about the why and how of OpenCPU are available from these papers:"</p>
<ul>
<li><p><a href="https://arxiv.org/abs/1406.4806" class="external-link">Towards a Universal Interface for Scientific Computing through Separation of Concerns</a></p></li>
<li><p><a href="https://arxiv.org/abs/1303.4808" class="external-link">Enforcing Security Policies in R Using Dynamic Sandboxing on Linux</a></p></li>
</ul>
</blockquote>
<p>For the <code>kwb.qmra</code> R package a very tiny example app (source code on <a href="https://github.com/KWB-R/kwb.qmra/tree/master/inst/www" class="external-link">GitHub</a>) was developed which uses the <a href="https://www.opencpu.org" class="external-link">OpenCPU</a> framework. This web app performs a quantitative microbiological risk assessment (QMRA) for a <a href="https://github.com/KWB-R/kwb.qmra/tree/master/inst/extdata/configs/dummy" class="external-link">dummy configuration</a> and can be tested here: <a href="https://kwb-r.ocpu.io/kwb.qmra/www/" class="external-link">https://kwb-r.ocpu.io/kwb.qmra/www/</a></p>
<p>More advanced web-apps can be easily developed by using the <a href="https://www.opencpu.org/api.html" class="external-link">OpenCPU API</a> but will most probably need an own backend server which hosts the OpenCPU server, because the <a href="https://www.opencpu.org/cloud.html" class="external-link">publically freely available OpenCPU server</a> might be too limited.</p>
</div>
<div class="section level2">
<h2 id="run-risk-simulatation">Run risk simulatation<a class="anchor" aria-label="anchor" href="#run-risk-simulatation"></a>
</h2>
<p>You need to provide the input parameters for <code><a href="../reference/opencpu_simulate_risk.html">kwb.qmra::opencpu_simulate_risk()</a></code> required in a JSON data structure as provided in the example data <a href="../config_dummy.json">config_dummy.json</a> (for details see: <code><a href="../reference/config_dummy_json.html">kwb.qmra::config_dummy_json</a></code>), which needs to be converted into an R list data structure (see below)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">### Convert "config.json" to R list</span>
<span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="st">"config_dummy.json"</span><span class="op">)</span>

<span class="co">### Optionally directly import a configuration from CSV files</span>
<span class="co">### for details see: https://github.com/KWB-R/kwb.qmra/tree/master/inst/extdata/configs</span>
<span class="co"># config_dir &lt;- system.file("extdata/configs/dummy", package = "kwb.qmra")</span>
<span class="co"># config &lt;- kwb.qmra::config_read(confDir = config_dir)</span>

<span class="co"># Run risk simulation</span>
<span class="va">risk_dummy</span> <span class="op">&lt;-</span> <span class="fu">kwb.qmra</span><span class="fu">::</span><span class="fu"><a href="../reference/opencpu_simulate_risk.html">opencpu_simulate_risk</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 0: BASIC CONFIGURATION</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Simulated 3 pathogen(s): Campylobacter jejuni and Campylobacter coli, Rotavirus, Giardia duodenalis</span>
<span class="co">#&gt; Number of random distribution repeatings: 10</span>
<span class="co">#&gt; Number of exposure events: 365</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 1: INFLOW</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Simulated pathogen: Campylobacter jejuni and Campylobacter coli</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 10.000000, max: 10000.000000)</span>
<span class="co">#&gt; Warning in data.frame(..., check.names = FALSE): row names were found from a</span>
<span class="co">#&gt; short variable and have been discarded</span>
<span class="co">#&gt; Simulated pathogen: Rotavirus</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 10.000000, max: 10000.000000)</span>
<span class="co">#&gt; Warning in data.frame(..., check.names = FALSE): row names were found from a</span>
<span class="co">#&gt; short variable and have been discarded</span>
<span class="co">#&gt; Simulated pathogen: Giardia duodenalis</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 10.000000, max: 10000.000000)</span>
<span class="co">#&gt; Warning in data.frame(..., check.names = FALSE): row names were found from a</span>
<span class="co">#&gt; short variable and have been discarded</span>
<span class="co">#&gt; Providing inflow events ... ok. (0.00s) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 2: TREATMENT SCHEMES</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.200000, max: 2.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 1.000000, max: 2.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.100000, max: 3.400000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.200000, max: 4.400000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.400000, max: 3.300000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.000000, max: 3.500000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 2.000000, max: 6.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.300000, max: 5.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.250000, max: 4.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 2.000000, max: 6.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 1.000000, max: 2.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 2.100000, max: 8.300000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 4.000000, max: 4.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 4.000000, max: 4.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 4.000000, max: 4.000000)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 3: EXPOSURE</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Simulated exposure: volume per event</span>
<span class="co">#&gt; Create 10 random distribution(s): triangle (n: 365, min: 0.500000, max: 3.000000, mode = 1.500000)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 4: DOSE RESPONSE</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 5: HEALTH</span>
<span class="va">risk_dummy_json</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">risk_dummy</span>, pretty <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># Save simulation results in JSON format</span>
<span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">risk_dummy_json</span>, <span class="st">"risk_dummy.json"</span><span class="op">)</span></code></pre></div>
<p>The structure of the optimisation results is stored in JSON format in the R object <code>predictions</code> and also saved. For inspecting it please open the <a href="../risk_dummy.json">risk_dummy.json</a> file.</p>
<p>Real calculations should be performed using the <a href="../config_default.json">config_default.json</a> configuration developed by Christoph Sprenger (<span class="citation">@chsprenger</span>). However, due to the large size of the resulting <code>risk_default.json</code> object (~ 275MB) this default example could not be hosted at GitHub (maximum single file size &lt;100MB). Thus this workflow was limited to the <code>dummy</code> configuration only!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://mrustl.de" class="external-link">Michael Rustler</a>, <a href="https://www.kompetenz-wasser.de/en/ueber-uns/team/hauke-sonnenberg" class="external-link">Hauke Sonnenberg</a>, <a href="https://www.kompetenz-wasser.de/en/forschung/projekte/aquanes" class="external-link"><img src="https://old.kompetenz-wasser.de/wp-content/uploads/2017/09/11-558x122.jpg" alt="Project AquaNES" width="72"></a>, <a href="https://www.kompetenz-wasser.de/en/forschung/projekte/demoware/" class="external-link"><img src="https://www.kompetenz-wasser.de/media/pages/forschung/projekte/demoware/46595105f4-1639132759/demoware-logo.png" alt="Project DEMOWARE" width="72"></a>, <a href="https://www.kompetenz-wasser.de/en/forschung/projekte/smart-control/" class="external-link"><img src="https://smart-control.inowas.com/wp-content/uploads/2020/06/cropped-SMART_logo_black.png" alt="Project Smart-Control" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
