<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web-app development with OpenCpu â€¢ kwb.qmra</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Web-app development with OpenCpu">
<meta property="og:description" content="kwb.qmra">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">kwb.qmra</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/general.html">Background</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Workflow
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/installation.html">1 Installation</a>
    </li>
    <li>
      <a href="../articles/usage.html">2 Usage (Uniform Inflow)</a>
    </li>
    <li>
      <a href="../articles/usage_log10_uniform_inflow.html">3 Usage (Log10 Uniform Inflow)</a>
    </li>
    <li>
      <a href="../articles/usage_log10_norm_inflow.html">4 Usage (Log10 Norm Inflow)</a>
    </li>
    <li>
      <a href="../articles/web_app.html">5 Web-app development</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tests
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/test_random_distributions_inflow.html">1 Random Distributions For Inflow</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kwb-r/kwb.qmra">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="web_app_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Web-app development with OpenCpu</h1>
                        <h4 class="author">Michael Rustler</h4>
            
            <h4 class="date">22 February, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/KWB-R/kwb.qmra/blob/master/vignettes/web_app.Rmd"><code>vignettes/web_app.Rmd</code></a></small>
      <div class="hidden name"><code>web_app.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level2">
<h2 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h2>
<p>For developing a web application, which is based on the R package <code>kwb.qmra</code> the <a href="https://www.opencpu.org/api.html">OpenCPU API</a> can be used. It has a lot of great features which its author Jeroen Ooms describes as follows (<a href="https://www.quora.com/How-do-plumber-and-OpenCPU-compare-when-it-comes-to-deploying-ML-models">Source</a>):</p>
<blockquote>
<p>"OpenCPU is mature has been put to the test in production for many years now, both in private and public organizations. The system was developed out of a need for a reliable, scalable system for embedding R that we used at UCLA for teaching R to students, sometimes several classes at once (think about a classroom settings with 100+ concurrent students). The core implementation of OpenCPU is the opencpu-server stack based on systems native Apache2 webserver. The opencpu-server stack has been packaged as deb/rpm packages and can be installed out of the box on all popular Linux systems. This really provides a super stable production ready system out-of-the-box. Not only does it easily scale up but you can configure the server (if you want to add auth, proxies, etc) via standard Apache configuration on your server. An incredible amount of time and energy has been invested into optimizing the internals of opencpu-server for security, reliability and performance. In opencpu-server, each incoming request gets processed in a temporary process fork which serves as a sandbox that controls memory/cpu limits, access control, timeouts, etc. All these are critical to ensure that the stability of the server does not get compromised by users or packages (accidentally) messing with the system or using excessive resources. I am not aware of any other R server system that does this.</p>
<p>More details about the why and how of OpenCPU are available from these papers:"</p>
<ul>
<li><p><a href="https://arxiv.org/abs/1406.4806">Towards a Universal Interface for Scientific Computing through Separation of Concerns</a></p></li>
<li><p><a href="https://arxiv.org/abs/1303.4808">Enforcing Security Policies in R Using Dynamic Sandboxing on Linux</a></p></li>
</ul>
</blockquote>
<p>For the <code>kwb.qmra</code> R package a very tiny example app (source code on <a href="https://github.com/KWB-R/kwb.qmra/tree/master/inst/www">GitHub</a>) was developed which uses the <a href="https://www.opencpu.org">OpenCPU</a> framework. This web app performs a quantitative microbiological risk assessment (QMRA) for a <a href="https://github.com/KWB-R/kwb.qmra/tree/master/inst/extdata/configs/dummy">dummy configuration</a> and can be tested here: <a href="https://kwb-r.ocpu.io/kwb.qmra/www/">https://kwb-r.ocpu.io/kwb.qmra/www/</a></p>
<p>More advanced web-apps can be easily developed by using the <a href="https://www.opencpu.org/api.html">OpenCPU API</a> but will most probably need an own backend server which hosts the OpenCPU server, because the <a href="https://www.opencpu.org/cloud.html">publically freely available OpenCPU server</a> might be too limited.</p>
</div>
<div id="run-risk-simulatation" class="section level2">
<h2 class="hasAnchor">
<a href="#run-risk-simulatation" class="anchor"></a>Run risk simulatation</h2>
<p>You need to provide the input parameters for <code><a href="../reference/opencpu_simulate_risk.html">kwb.qmra::opencpu_simulate_risk()</a></code> required in a JSON data structure as provided in the example data <a href="../config_dummy.json">config_dummy.json</a> (for details see: <code><a href="../reference/config_dummy_json.html">kwb.qmra::config_dummy_json</a></code>), which needs to be converted into an R list data structure (see below)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">### Convert "config.json" to R list</span>
<span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="st">"config_dummy.json"</span><span class="op">)</span>

<span class="co">### Optionally directly import a configuration from CSV files</span>
<span class="co">### for details see: https://github.com/KWB-R/kwb.qmra/tree/master/inst/extdata/configs</span>
<span class="co"># config_dir &lt;- system.file("extdata/configs/dummy", package = "kwb.qmra")</span>
<span class="co"># config &lt;- kwb.qmra::config_read(confDir = config_dir)</span>

<span class="co"># Run risk simulation</span>
<span class="va">risk_dummy_json</span> <span class="op">&lt;-</span> <span class="fu">kwb.qmra</span><span class="fu">::</span><span class="fu"><a href="../reference/opencpu_simulate_risk.html">opencpu_simulate_risk</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 0: BASIC CONFIGURATION</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Simulated 3 pathogen(s): Campylobacter jejuni and Campylobacter coli, Rotavirus, Giardia duodenalis</span>
<span class="co">#&gt; Number of random distribution repeatings: 10</span>
<span class="co">#&gt; Number of exposure events: 365</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 1: INFLOW</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Simulated pathogen: Campylobacter jejuni and Campylobacter coli</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 10.000000, max: 10000.000000)</span>
<span class="co">#&gt; Warning in data.frame(..., check.names = FALSE): row names were found from a</span>
<span class="co">#&gt; short variable and have been discarded</span>
<span class="co">#&gt; Simulated pathogen: Rotavirus</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 10.000000, max: 10000.000000)</span>
<span class="co">#&gt; Warning in data.frame(..., check.names = FALSE): row names were found from a</span>
<span class="co">#&gt; short variable and have been discarded</span>
<span class="co">#&gt; Simulated pathogen: Giardia duodenalis</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 10.000000, max: 10000.000000)</span>
<span class="co">#&gt; Warning in data.frame(..., check.names = FALSE): row names were found from a</span>
<span class="co">#&gt; short variable and have been discarded</span>
<span class="co">#&gt; Providing inflow events ... ok. (0.00s) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 2: TREATMENT SCHEMES</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.200000, max: 2.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 1.000000, max: 2.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.100000, max: 3.400000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.200000, max: 4.400000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.400000, max: 3.300000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.000000, max: 3.500000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 2.000000, max: 6.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.300000, max: 5.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 0.250000, max: 4.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 2.000000, max: 6.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 1.000000, max: 2.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 2.100000, max: 8.300000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 4.000000, max: 4.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 4.000000, max: 4.000000)</span>
<span class="co">#&gt; Create 10 random distribution(s): uniform (n: 365, min: 4.000000, max: 4.000000)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 3: EXPOSURE</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Simulated exposure: volume per event</span>
<span class="co">#&gt; Create 10 random distribution(s): triangle (n: 365, min: 0.500000, max: 3.000000, mode = 1.500000)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 4: DOSE RESPONSE</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # STEP 5: HEALTH</span>

<span class="co"># Save simulation results in JSON format</span>
<span class="fu"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">risk_dummy_json</span>, <span class="st">"risk_dummy.json"</span><span class="op">)</span></code></pre></div>
<p>The structure of the optimisation results is stored in JSON format in the R object <code>predictions</code> and also saved. For inspecting it please open the <a href="../risk_dummy.json">risk_dummy.json</a> file.</p>
<p>Real calculations should be performed using the <a href="../config_default.json">config_default.json</a> configuration developed by Christoph Sprenger (<span class="citation">@chsprenger</span>). However, due to the large size of the resulting <code>risk_default.json</code> object (~ 275MB) this default example could not be hosted at GitHub (maximum single file size &lt;100MB). Thus this workflow was limited to the <code>dummy</code> configuration only!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://mrustl.de">Michael Rustler</a>, <a href="https://github.com/hsonne">Hauke Sonnenberg</a>, <a href="https://www.kompetenz-wasser.de/en/project/aquanes/"><img src="https://www.kompetenz-wasser.de/wp-content/uploads/2017/09/11-558x122.jpg" height="24"></a>, <a href="https://www.kompetenz-wasser.de/en/project/demoware/"><img src="https://www.kompetenz-wasser.de/wp-content/uploads/2017/05/demoware-logo.png" height="24"></a>, <a href="https://www.kompetenz-wasser.de/en/project/smart-control/"><img src="https://smart-control.inowas.com/wp-content/uploads/2020/06/cropped-SMART_logo_black.png" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'ba545525664b60ab9e580ae0f7f4ac02',
    indexName: 'kwb_qmra',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
